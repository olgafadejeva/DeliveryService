@using DeliveryService.Models.DriverViewModels
@model DriverDashboardModel
@using Newtonsoft.Json
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<html>
<head>
    <style>
        #map {
            height: 1000px;
            width: 100%;
        }

        .container {
            width: 80%;
        }

            .container > .navbar-header, .container-fluid > .navbar-header, .container > .navbar-collapse, .container-fluid > .navbar-collapse {
                margin-right: 50px;
                margin-left: 50px;
            }

        #mapArea {
            height: 1000px;
        }
    </style>

</head>
<body>
    <h2>@Model.Driver.User.DisplayFirstName's Dashboard</h2>


    <a asp-action="Index" asp-controller="DriverRoutes" class="btn btn-default">My routes</a>
    <a asp-action="Index" asp-controller="DriverDetails" class="btn btn-default">My details</a>
    @if (Model.Driver.Vehicles.ToList().Count == 0)
    {
        <p> Please take time to add your vehicles into the system! Otherwise no routes can be assigned to you.</p>
        <a asp-action="Create" asp-controller="Vehicles" class="btn btn-warning">Add a vehicle</a>

    }
    else
    {
        <a asp-action="Index" asp-controller="Vehicles" class="btn btn-default">My vehicles</a>
    }

    <h2>Routes summary</h2>
    <div id="mapArea">
        <div class="row">
            <div class="col-sm-10">
                <div id="map"></div>
            </div>
            <div class="col-sm-2" id="infoPanel">
                @if (Model.routesModel.Count == 0)
                {
                    <p>There are currently NO routes assigned to you. Once routes are assigned, you will be able to see them on the map on the left</p>
                }
                else
                {
                <p>All routes on the map are either In Progress or New. The other routes can be acccessed from the <span>@Html.ActionLink("Routes", "Index", "DriverRoutes") tab</span></p>
                }
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var map;
        var colors = []
        for (var i =0; i<=20; i++) {
            colors[i] = Math.floor(Math.random()*16777215).toString(16);
        }
        var colorIndex = 0;



        var color = '#' + colors[colorIndex];
        console.log(color);
        var polylineOptions = {
            strokeColor: color
        };
        var polylines = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            center: { lat: 53.3811, lng: -1.4701 }
        });
        map.setOptions({'scrollwheel': false});
        googleMap = map;
        var directionsService = new google.maps.DirectionsService;

        var routesModel = @Html.Raw(JsonConvert.SerializeObject(Model.routesModel));

        var parentElement = document.getElementById("infoPanel");
        var list = document.createElement('ul');
        list.classList.add("list-group");


        for (var k = 0; k < routesModel.length; k++) {
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var delivery = routesModel[k]
            var waypoints = delivery.waypoints;
            var start = delivery.depotAddress;

           // directionsDisplay.setMap(map);
            console.log(routesModel);

            var waypts = [];
            for (var i = 0; i < waypoints.length; i++) {
                waypts.push({
                    location: waypoints[i],
                    stopover: true
                });
            }

            var item = document.createElement('div');

            var label = document.createElement('span');
            label.classList.add("label");
            label.classList.add("label-default");
            label.innerHTML = "route";

            label.setAttribute("style", "background-color: #" + colors[k] + ";");
            item.appendChild(label);


            var paragraph = document.createElement('p');
            if (delivery.scheduledOn != null) {
                paragraph.innerHTML = "Scheduled on: " + delivery.scheduledOn;
                item.appendChild(paragraph);
            }

            var paragraph2 = document.createElement('p');
            paragraph2.innerHTML =  "Deliver by: " + delivery.deliverBy;
            item.appendChild(paragraph2);

            var paragraph3 = document.createElement('p');
            paragraph3.innerHTML = "Total deliveries: " + waypoints.length;
            item.appendChild(paragraph3);
            item.classList.add("list-group-item");

            list.appendChild(item);


            directionsService.route({
                origin: start,
                destination: start,
                waypoints: waypts,
                optimizeWaypoints: true,
                travelMode: 'DRIVING'
            }, function(result) {
                var polylineOptionsActual = {
                    strokeColor: '#' + colors[colorIndex],
                    strokeOpacity: 1.0,
                    strokeWeight: 4
                };
                directionsRenderer = new google.maps.DirectionsRenderer({ polylineOptions: polylineOptionsActual});
                directionsRenderer.setMap(map);
                directionsRenderer.setDirections(result);
                colorIndex++;
                color = '#' + colors[colorIndex];
            });

            parentElement.appendChild(list);
        }

    }

    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCruDMQXf92lZMvfCEO_L9E2oYjvuRfPaI&callback=initMap">
    </script>
</body>
</html>